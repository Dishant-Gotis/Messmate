<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MessMate - Discover Local Mess Services</title>
  <meta name="description" content="Discover local mess (communal dining) services. Admin dashboard to manage messes and students. Built with HTML, CSS, JS and Firebase." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='48' fill='%23FF6B35'/%3E%3Ctext x='50' y='60' text-anchor='middle' font-size='44' fill='white'%3EM%3C/text%3E%3C/svg%3E" />
  <style>
    :root {
      --primary: #FF6B35;
      --secondary: #004E89;
      --success: #10B981;
      --error: #EF4444;
      --warning: #F59E0B;
      --veg: #22C55E;
      --non-veg: #EF4444;
      --both: #F59E0B;
      --bg-light: #F9FAFB;
      --bg-white: #FFFFFF;
      --text-dark: #1F2937;
      --text-gray: #6B7280;
      --border: #E5E7EB;
      --shadow: 0 10px 20px rgba(0,0,0,0.06);
      --radius: 12px;
      --radius-sm: 8px;
      --radius-lg: 16px;
      --max-w: 1200px;
    }

    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text-dark);
      background: var(--bg-light);
      line-height: 1.6;
    }

    /* Navbar */
    .navbar {
      position: sticky;
      top: 0;
      z-index: 50;
      background: var(--bg-white);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; }
    .brand-logo { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); color: #fff; display:flex; align-items:center; justify-content:center; font-weight:900; }
    .nav-actions { display: flex; gap: 10px; align-items: center; }

    .btn {
      padding: 10px 16px;
      border-radius: var(--radius-sm);
      border: 1px solid transparent;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: var(--shadow);
    }
    .btn:hover { filter: brightness(.98); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background: var(--secondary); }
    .btn.gray { background: #111827; }
    .btn.ghost { background: transparent; color: var(--text-dark); border-color: var(--border); box-shadow: none; }
    .btn.ghost:hover { background: #F3F4F6; }
    .btn.success { background: var(--success); }
    .btn.error { background: var(--error); }
    .btn.warning { background: var(--warning); color: #111; }
    .btn.small { padding: 6px 10px; font-size: 14px; }

    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 999px; font-weight: 700; font-size: 12px; }
    .badge.veg { background: #ECFDF5; color: var(--veg); border: 1px solid #D1FAE5; }
    .badge.non-veg { background: #FEF2F2; color: var(--non-veg); border: 1px solid #FECACA; }
    .badge.both { background: #FFFBEB; color: var(--both); border: 1px solid #FDE68A; }

    .container { width: 100%; max-width: var(--max-w); margin: 0 auto; padding: 20px; }

    /* Auth view */
    .card { background: var(--bg-white); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); }
    .auth-card { max-width: 460px; margin: 40px auto; padding: 28px; }
    .auth-title { margin: 0 0 8px 0; font-size: 28px; font-weight: 800; }
    .muted { color: var(--text-gray); font-size: 14px; }

    .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .label { font-weight: 700; font-size: 14px; }
    .input, .select, .textarea {
      padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-sm); outline: none; font-size: 15px; background: #fff; color: var(--text-dark);
    }
    .textarea { min-height: 80px; resize: vertical; }
    .field-inline { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .error-text { color: var(--error); font-size: 13px; margin-top: -6px; margin-bottom: 8px; }

    /* Student grid */
    .filters { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; margin-bottom: 16px; }
    .filters .spacer { flex: 1 1 auto; }
    .search { width: 320px; max-width: 100%; }

    .grid { display: grid; gap: 16px; }
    @media (min-width: 1200px) { .grid.mess { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 768px) and (max-width: 1199px) { .grid.mess { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 767px) { .grid.mess { grid-template-columns: 1fr; } }

    .mess-card { padding: 16px; display: flex; flex-direction: column; gap: 12px; }
    .mess-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .mess-name { font-size: 18px; font-weight: 800; margin: 0; }
    .rating { font-weight: 800; color: #111827; }
    .menu { color: var(--text-gray); font-size: 14px; }
    .pill-row { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Admin layout */
    .admin-wrap { display: grid; grid-template-columns: 260px 1fr; min-height: calc(100vh - 62px); }
    .sidebar { background: #0B1E39; color: #fff; padding: 20px; position: sticky; top: 62px; height: calc(100vh - 62px); display: flex; flex-direction: column; gap: 8px; }
    .side-title { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; opacity: .7; margin-bottom: 4px; }
    .side-link { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; color: #C9D4E6; cursor: pointer; font-weight: 700; }
    .side-link.active, .side-link:hover { background: rgba(255,255,255,.08); color: #fff; }
    .side-footer { margin-top: auto; }

    .admin-main { padding: 20px; }
    .section-title { font-weight: 800; font-size: 24px; margin: 0 0 16px 0; }
    .cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
    .stat { padding: 16px; }
    .stat h3 { margin: 0; font-size: 14px; color: var(--text-gray); }
    .stat .num { font-size: 28px; font-weight: 900; margin-top: 8px; }
    @media (max-width: 1199px) { .cards { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 767px) {
      .admin-wrap { grid-template-columns: 1fr; }
      .sidebar { position: relative; top: 0; height: auto; flex-direction: row; flex-wrap: wrap; gap: 6px; }
      .side-link { padding: 8px 10px; }
      .cards { grid-template-columns: 1fr; }
    }

    /* Tables */
    .table-wrap { background: #fff; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow); }
    table { width: 100%; border-collapse: collapse; }
    thead { background: #F3F4F6; }
    th, td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: top; }
    tbody tr:hover { background: #FAFAFB; }
    .table-actions { display: flex; gap: 8px; }

    /* Modals */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(2px); }
    .overlay.show { display: flex; }
    .modal { width: 96%; max-width: 620px; background: #fff; border-radius: var(--radius-lg); box-shadow: var(--shadow); overflow: hidden; }
    .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-body { padding: 16px 20px; max-height: 70vh; overflow: auto; }
    .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end; }

    /* Toasts */
    .toast-container { position: fixed; top: 16px; right: 16px; display: flex; flex-direction: column; gap: 10px; z-index: 120; }
    .toast { padding: 12px 16px; border-radius: 10px; color: #fff; box-shadow: var(--shadow); font-weight: 700; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--error); }
    .toast.info { background: var(--secondary); }

    /* Loaders */
    .spinner { width: 18px; height: 18px; border: 3px solid #fff; border-top-color: rgba(255,255,255,.2); border-radius: 50%; animation: spin .8s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .skeleton { background: linear-gradient(90deg, #eee, #f7f7f7, #eee); background-size: 200% 100%; animation: shimmer 1.2s infinite; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    .skeleton-card { height: 170px; border-radius: var(--radius); }

    .hidden { display: none !important; }
    .mt-10 { margin-top: 10px; }
    .mt-16 { margin-top: 16px; }
    .mt-20 { margin-top: 20px; }
    .mb-10 { margin-bottom: 10px; }
    .mb-16 { margin-bottom: 16px; }
    .mb-20 { margin-bottom: 20px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <!-- Navbar -->
  <header class="navbar">
    <div class="brand">
      <div class="brand-logo">M</div>
      <div>
        <div style="font-size:18px;">MessMate</div>
        <div class="muted" style="margin-top:-4px;">Discover local mess services</div>
      </div>
    </div>
    <div class="nav-actions">
      <div id="nav-user" class="muted"></div>
      <button id="btn-logout" class="btn ghost hidden">Logout</button>
    </div>
  </header>

  <!-- Toasts -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Global Modal/Overlay -->
  <div id="modal-overlay" class="overlay" aria-hidden="true"></div>

  <!-- AUTH VIEW -->
  <main id="auth-view" class="container">
    <div class="card auth-card">
      <h1 class="auth-title">Welcome to MessMate</h1>
      <p class="muted">Login or create an account to continue</p>

      <div id="auth-tabs" class="row mt-16">
        <button id="tab-login" class="btn secondary">Login</button>
        <button id="tab-register" class="btn ghost">Register</button>
      </div>

      <form id="form-login" class="mt-16" autocomplete="on">
        <div class="field">
          <label class="label">Email*</label>
          <input id="login-email" type="email" class="input" placeholder="you@example.com" required />
        </div>
        <div class="field">
          <label class="label">Password*</label>
          <input id="login-password" type="password" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
          <div class="muted" style="font-size:12px;">Admin login: use the admin credentials exactly.</div>
        </div>
        <button id="btn-login" type="submit" class="btn" style="width:100%">Login</button>
        <div id="login-error" class="error-text hidden"></div>
        <div class="mt-16" style="text-align:center;color:var(--text-gray)">or</div>
        <button id="btn-google-login" type="button" class="btn gray" style="width:100%; margin-top:10px;">Continue with Google</button>
      </form>

      <form id="form-register" class="mt-16 hidden" autocomplete="on">
        <div class="field-inline">
          <div class="field">
            <label class="label">Full Name*</label>
            <input id="reg-name" class="input" required />
          </div>
          <div class="field">
            <label class="label">Phone Number*</label>
            <input id="reg-phone" class="input" placeholder="+91XXXXXXXXXX" required />
          </div>
        </div>
        <div class="field">
          <label class="label">Email*</label>
          <input id="reg-email" type="email" class="input" required />
        </div>
        <div class="field-inline">
          <div class="field">
            <label class="label">Password*</label>
            <input id="reg-password" type="password" class="input" required />
          </div>
          <div class="field">
            <label class="label">Confirm Password*</label>
            <input id="reg-password2" type="password" class="input" required />
          </div>
        </div>
        <div class="field">
          <label class="label">Address (optional)</label>
          <textarea id="reg-address" class="textarea" placeholder="Your full address"></textarea>
        </div>
        <button id="btn-register" type="submit" class="btn" style="width:100%">Create Account</button>
        <div id="register-error" class="error-text hidden"></div>
        <div class="mt-16" style="text-align:center;color:var(--text-gray)">or</div>
        <button id="btn-google-register" type="button" class="btn gray" style="width:100%; margin-top:10px;">Continue with Google</button>
      </form>
    </div>
  </main>

  <!-- STUDENT VIEW -->
  <section id="student-view" class="container hidden">
    <div class="row mb-16">
      <h2 class="section-title" style="margin:0">Find a great mess near you</h2>
    </div>
    <div class="filters card" style="padding:12px;">
      <div class="row">
        <div class="row" role="group" aria-label="Filter mess type">
          <button class="btn ghost small" data-filter="all">All</button>
          <button class="btn ghost small" data-filter="veg">Veg</button>
          <button class="btn ghost small" data-filter="non-veg">Non-Veg</button>
          <button class="btn ghost small" data-filter="both">Both</button>
        </div>
        <div class="spacer"></div>
        <input id="search-input" class="input search" placeholder="Search mess name..." />
        <select id="sort-select" class="select">
          <option value="distance">Sort: Nearest</option>
          <option value="rating">Sort: Rating</option>
          <option value="price-asc">Sort: Price (Low to High)</option>
          <option value="price-desc">Sort: Price (High to Low)</option>
        </select>
      </div>
    </div>

    <div id="student-loading" class="grid mess">
      <div class="card skeleton-card skeleton"></div>
      <div class="card skeleton-card skeleton"></div>
      <div class="card skeleton-card skeleton"></div>
    </div>

    <div id="mess-grid" class="grid mess hidden"></div>
    <div id="student-empty" class="card hidden" style="padding:20px; text-align:center;">
      <div style="font-size:40px;">üçΩÔ∏è</div>
      <h3 style="margin:8px 0 0 0;">No messes found</h3>
      <p class="muted">Try changing filters or search terms.</p>
    </div>
  </section>

  <!-- ADMIN VIEW -->
  <section id="admin-view" class="hidden">
    <div class="admin-wrap">
      <aside class="sidebar">
        <div class="side-title">Admin</div>
        <div class="side-link active" data-admin-page="dashboard">üìä Dashboard Overview</div>
        <div class="side-link" data-admin-page="messes">üçΩÔ∏è Manage Messes</div>
        <div class="side-link" data-admin-page="students">üë• Student Data</div>
        <div class="side-footer">
          <div class="side-link" id="admin-logout">üö™ Logout</div>
        </div>
      </aside>
      <main class="admin-main">
        <!-- Dashboard -->
        <section id="admin-dashboard" class="admin-page">
          <div class="row" style="justify-content: space-between; align-items: center;">
            <h2 class="section-title">Dashboard Overview</h2>
            <div class="row">
              <button id="btn-seed" class="btn warning">Seed Sample Data</button>
            </div>
          </div>
          <div class="cards">
            <div class="card stat">
              <h3>Total Messes</h3>
              <div class="num" id="stat-messes">0</div>
            </div>
            <div class="card stat">
              <h3>Total Students</h3>
              <div class="num" id="stat-students">0</div>
            </div>
            <div class="card stat">
              <h3>Average Rating</h3>
              <div class="num" id="stat-rating">0.0 ‚≠ê</div>
            </div>
            <div class="card stat">
              <h3>Most Popular Mess</h3>
              <div class="num" id="stat-popular">‚Äî</div>
            </div>
          </div>
        </section>

        <!-- Manage Messes -->
        <section id="admin-messes" class="admin-page hidden">
          <div class="row" style="justify-content: space-between; align-items: center;">
            <h2 class="section-title">Manage Messes</h2>
            <div class="row">
              <input id="messes-search" class="input" placeholder="Search messes..." />
              <button id="btn-add-mess" class="btn">Add New Mess</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Mess Name</th>
                  <th>Type</th>
                  <th>Price (‚Çπ)</th>
                  <th>Rating</th>
                  <th>Phone</th>
                  <th style="width: 140px;">Actions</th>
                </tr>
              </thead>
              <tbody id="messes-tbody"></tbody>
            </table>
          </div>
        </section>

        <!-- Student Data -->
        <section id="admin-students" class="admin-page hidden">
          <div class="row" style="justify-content: space-between; align-items: center;">
            <h2 class="section-title">Student Data</h2>
            <div class="row">
              <input id="students-search" class="input" placeholder="Search name or email..." />
              <button id="btn-add-student" class="btn">Add New Student</button>
              <button id="btn-export-students" class="btn ghost">Export CSV</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Student Name</th>
                  <th>Email</th>
                  <th>Phone</th>
                  <th>Registration Date</th>
                  <th>Status</th>
                  <th style="width: 140px;">Actions</th>
                </tr>
              </thead>
              <tbody id="students-tbody"></tbody>
            </table>
          </div>
        </section>
      </main>
    </div>
  </section>

  <script>
    // Admin credentials
    const ADMIN_EMAIL = 'dishantgotisdg9881@gmail.com';
    const ADMIN_PASSWORD = 'iamadmin';

    // Basic state
    const state = {
      user: null,
      role: null, // 'admin' | 'student'
      messes: [],
      students: [],
      userLocation: null,
      unsub: { messes: null, students: null },
      loading: { messes: false, students: false }
    };

    // Utilities: Toasts
    function showToast(message, type = 'info') {
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      el.textContent = message;
      document.getElementById('toast-container').appendChild(el);
      setTimeout(() => el.remove(), 3000);
    }

    // Utilities: Modal/Confirm
    function openModal({ title = '', body = '', actions = [] }) {
      const overlay = document.getElementById('modal-overlay');
      overlay.innerHTML = `
        <div class="modal" role="dialog" aria-modal="true">
          <div class="modal-header">
            <strong>${title}</strong>
            <button class="btn ghost small" id="modal-close">‚úñ</button>
          </div>
          <div class="modal-body">${body}</div>
          <div class="modal-footer">
            ${actions.map((a, i) => `<button class="btn ${a.class || ''}" data-i="${i}">${a.label}</button>`).join('')}
          </div>
        </div>`;
      overlay.classList.add('show');
      overlay.onclick = (e) => { if (e.target === overlay) closeModal(); };
      document.getElementById('modal-close').onclick = closeModal;
      const buttons = overlay.querySelectorAll('.modal-footer .btn');
      buttons.forEach(btn => btn.addEventListener('click', () => {
        const i = +btn.getAttribute('data-i');
        const action = actions[i];
        if (action && action.onClick) action.onClick();
      }));
      document.addEventListener('keydown', escCloseOnce);
    }
    function escCloseOnce(e){ if (e.key === 'Escape') { closeModal(); document.removeEventListener('keydown', escCloseOnce);} }
    function closeModal(){ const overlay = document.getElementById('modal-overlay'); overlay.classList.remove('show'); overlay.innerHTML = ''; }
    function confirmDialog(message, onYes){
      openModal({
        title: 'Please Confirm',
        body: `<p>${message}</p>`,
        actions: [
          { label: 'Cancel', class: 'ghost', onClick: closeModal },
          { label: 'Yes, Confirm', class: 'error', onClick: () => { closeModal(); onYes && onYes(); } }
        ]
      });
    }

    // Firebase init with fallback config prompt
    function loadFirebaseConfig() {
      // Replace the object below with your Firebase config, or paste it via the setup modal on first load.
      const placeholder = {
        apiKey: 'YOUR_API_KEY',
        authDomain: 'YOUR_AUTH_DOMAIN',
        projectId: 'YOUR_PROJECT_ID',
        storageBucket: 'YOUR_STORAGE_BUCKET',
        messagingSenderId: 'YOUR_MESSAGING_SENDER_ID',
        appId: 'YOUR_APP_ID'
      };
      try {
        const saved = localStorage.getItem('messmate_firebase_config');
        if (saved) return JSON.parse(saved);
      } catch {}
      return placeholder;
    }

    function promptFirebaseConfigIfNeeded(config) {
      const needs = !config || !config.apiKey || config.apiKey === 'YOUR_API_KEY';
      if (!needs) return false;
      openModal({
        title: 'Setup Firebase',
        body: `
          <p>Paste your Firebase web app config JSON here to initialize the app.</p>
          <pre class="card" style="padding:10px; white-space: pre-wrap;">{
  "apiKey": "...",
  "authDomain": "...",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}</pre>
          <textarea id="cfg" class="textarea" placeholder="{\n  \"apiKey\": \"...\",\n  ...\n}"></textarea>
        `,
        actions: [
          { label: 'Cancel', class: 'ghost', onClick: closeModal },
          { label: 'Save & Reload', class: 'success', onClick: () => {
              try {
                const text = document.getElementById('cfg').value.trim();
                const obj = JSON.parse(text);
                localStorage.setItem('messmate_firebase_config', JSON.stringify(obj));
                closeModal();
                location.reload();
              } catch (e) { showToast('Invalid JSON. Please try again.', 'error'); }
            }
          }
        ]
      });
      return true;
    }

    let firebaseApp, auth, db;
    (function initFirebase(){
      const config = loadFirebaseConfig();
      if (promptFirebaseConfigIfNeeded(config)) return;
      firebaseApp = firebase.initializeApp(config);
      auth = firebase.auth();
      db = firebase.firestore();
    })();

    // Navigation helpers
    function updateNavbar(){
      const navUser = document.getElementById('nav-user');
      const btnLogout = document.getElementById('btn-logout');
      if (state.user) {
        navUser.textContent = `${state.user.email} ${state.role === 'admin' ? '(Admin)' : ''}`;
        btnLogout.classList.remove('hidden');
      } else {
        navUser.textContent = '';
        btnLogout.classList.add('hidden');
      }
    }

    function showView(view){
      document.getElementById('auth-view').classList.add('hidden');
      document.getElementById('student-view').classList.add('hidden');
      document.getElementById('admin-view').classList.add('hidden');
      if (view === 'auth') document.getElementById('auth-view').classList.remove('hidden');
      if (view === 'student') document.getElementById('student-view').classList.remove('hidden');
      if (view === 'admin') document.getElementById('admin-view').classList.remove('hidden');
    }

    function showAdminPage(id){
      document.querySelectorAll('.admin-page').forEach(p => p.classList.add('hidden'));
      document.getElementById(`admin-${id}`).classList.remove('hidden');
      document.querySelectorAll('.side-link').forEach(el => el.classList.remove('active'));
      const active = Array.from(document.querySelectorAll('.side-link')).find(el => el.dataset.adminPage === id);
      if (active) active.classList.add('active');
    }

    // Auth
    async function login(email, password){
      try {
        if (email === ADMIN_EMAIL && password !== ADMIN_PASSWORD) {
          throw new Error('Admin credentials incorrect.');
        }
        await auth.signInWithEmailAndPassword(email, password);
        showToast('Logged in successfully', 'success');
      } catch (e){
        document.getElementById('login-error').textContent = e.message;
        document.getElementById('login-error').classList.remove('hidden');
      }
    }

    async function register(email, password, userData){
      try {
        if (email === ADMIN_EMAIL) throw new Error('Admin account cannot be registered here. Use login.');
        const res = await auth.createUserWithEmailAndPassword(email, password);
        const uid = res.user.uid;
        // Create student document
        await db.collection('students').doc(uid).set({
          id: uid,
          name: userData.name,
          email,
          phone: userData.phone,
          address: userData.address || '',
          status: 'active',
          registeredAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast('Account created. You are logged in.', 'success');
      } catch (e){
        document.getElementById('register-error').textContent = e.message;
        document.getElementById('register-error').classList.remove('hidden');
      }
    }

    function logout(){ auth.signOut(); }

    function isAdmin(email){ return email === ADMIN_EMAIL; }

    // Google Sign-In
    async function loginWithGoogle(){
      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
        showToast('Logged in with Google', 'success');
      } catch (e){
        showToast(e.message, 'error');
      }
    }

    // Ensure a student profile exists for Google sign-ins
    async function ensureStudentProfile(user){
      if (!user) return;
      if (isAdmin(user.email)) return; // admin doesn't need a student doc
      const ref = db.collection('students').doc(user.uid);
      const snap = await ref.get();
      if (!snap.exists){
        const now = firebase.firestore.FieldValue.serverTimestamp();
        await ref.set({
          id: user.uid,
          name: user.displayName || '',
          email: user.email || '',
          phone: '',
          address: '',
          status: 'active',
          registeredAt: now,
          updatedAt: now
        });
      }
    }

    // Firestore: Messes CRUD
    async function addMess(data){
      const now = firebase.firestore.FieldValue.serverTimestamp();
      return db.collection('messes').add({
        ...data,
        createdAt: now,
        updatedAt: now
      });
    }
    async function updateMess(id, data){
      const now = firebase.firestore.FieldValue.serverTimestamp();
      return db.collection('messes').doc(id).update({ ...data, updatedAt: now });
    }
    async function deleteMess(id){ return db.collection('messes').doc(id).delete(); }

    async function fetchMessesOnce(){
      const snap = await db.collection('messes').get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // Firestore: Students CRUD
    async function addStudent(data){
      const now = firebase.firestore.FieldValue.serverTimestamp();
      return db.collection('students').add({
        ...data,
        registeredAt: now,
        updatedAt: now
      });
    }
    async function updateStudent(id, data){
      const now = firebase.firestore.FieldValue.serverTimestamp();
      return db.collection('students').doc(id).update({ ...data, updatedAt: now });
    }
    async function deleteStudent(id){ return db.collection('students').doc(id).delete(); }

    async function fetchStudentsOnce(){
      const snap = await db.collection('students').get();
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // Distance utilities
    function toRad(v){ return v * Math.PI / 180; }
    function calculateDistance(lat1, lon1, lat2, lon2){
      if ([lat1, lon1, lat2, lon2].some(v => v == null || isNaN(v))) return null;
      const R = 6371; // km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function openMap(lat, lng) { window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank'); }
    function makeCall(phoneNumber) { window.location.href = `tel:${phoneNumber}`; }

    // Rendering: Student mess cards
    function renderMessCards(messes){
      const grid = document.getElementById('mess-grid');
      grid.innerHTML = '';
      if (!messes.length){
        document.getElementById('student-empty').classList.remove('hidden');
        grid.classList.add('hidden');
        return;
      }
      document.getElementById('student-empty').classList.add('hidden');
      grid.classList.remove('hidden');

      messes.forEach(m => {
        const dist = state.userLocation && m.coordinates ? calculateDistance(state.userLocation.lat, state.userLocation.lng, m.coordinates.lat, m.coordinates.lng) : null;
        const badgeClass = m.type === 'veg' ? 'veg' : m.type === 'non-veg' ? 'non-veg' : 'both';
        const el = document.createElement('div');
        el.className = 'card mess-card';
        el.innerHTML = `
          <div class="mess-header">
            <h3 class="mess-name">${escapeHtml(m.name)}</h3>
            <div class="rating">${Number(m.rating).toFixed(1)} ‚≠ê</div>
          </div>
          <div class="pill-row">
            <span class="badge ${badgeClass}">${m.type.replace('-', ' ').toUpperCase()}</span>
            <span class="badge" style="background:#EEF2FF;color:#3730A3;border:1px solid #C7D2FE;">‚Çπ ${Number(m.pricePerMeal).toFixed(0)}</span>
            ${dist != null ? `<span class="badge" style="background:#ECFEFF;color:#155E75;border:1px solid #A5F3FC;">${dist.toFixed(2)} km</span>` : ''}
          </div>
          <div class="menu"><strong>Today's Menu:</strong> ${(m.todaysMenu||[]).map(escapeHtml).join(', ')}</div>
          <div class="muted">${escapeHtml(m.address||'')}</div>
          <div class="actions">
            <button class="btn ghost small" ${m.coordinates ? '' : 'disabled'} onclick="openMap(${m.coordinates?.lat||0}, ${m.coordinates?.lng||0})">View on Map</button>
            <button class="btn small" onclick="makeCall('${m.phone||''}')">Call</button>
          </div>
        `;
        grid.appendChild(el);
      });
    }

    // Filtering/sorting for student
    function applyStudentQuery(){
      const filter = document.querySelector('.filters [data-filter].active')?.dataset.filter || 'all';
      const q = (document.getElementById('search-input').value || '').toLowerCase();
      const sort = document.getElementById('sort-select').value;

      let arr = [...state.messes];
      if (filter !== 'all') arr = arr.filter(m => m.type === filter);
      if (q) arr = arr.filter(m => m.name.toLowerCase().includes(q));

      // computed distance
      arr = arr.map(m => {
        const dist = state.userLocation && m.coordinates ? calculateDistance(state.userLocation.lat, state.userLocation.lng, m.coordinates.lat, m.coordinates.lng) : null;
        return { ...m, _dist: dist };
      });

      if (sort === 'distance') arr.sort((a,b) => (a._dist ?? Infinity) - (b._dist ?? Infinity));
      if (sort === 'rating') arr.sort((a,b) => Number(b.rating) - Number(a.rating));
      if (sort === 'price-asc') arr.sort((a,b) => Number(a.pricePerMeal) - Number(b.pricePerMeal));
      if (sort === 'price-desc') arr.sort((a,b) => Number(b.pricePerMeal) - Number(a.pricePerMeal));

      renderMessCards(arr);
    }

    // Admin rendering: messes table
    function renderMessTable(messes){
      const tbody = document.getElementById('messes-tbody');
      tbody.innerHTML = '';
      const q = (document.getElementById('messes-search').value||'').toLowerCase();
      messes.filter(m => !q || m.name.toLowerCase().includes(q)).forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(m.name)}</td>
          <td>${badgeHtml(m.type)}</td>
          <td>‚Çπ ${Number(m.pricePerMeal).toFixed(0)}</td>
          <td>${Number(m.rating).toFixed(1)} ‚≠ê</td>
          <td>${escapeHtml(m.phone||'')}</td>
          <td>
            <div class="table-actions">
              <button class="btn ghost small" data-edit="${m.id}">‚úèÔ∏è Edit</button>
              <button class="btn error small" data-delete="${m.id}">üóëÔ∏è Delete</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      // actions
      tbody.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', () => openMessModal('edit', state.messes.find(x => x.id === btn.dataset.edit))));
      tbody.querySelectorAll('[data-delete]').forEach(btn => btn.addEventListener('click', () => {
        const m = state.messes.find(x => x.id === btn.dataset.delete);
        confirmDialog(`Are you sure you want to delete "${m.name}"?`, async () => {
          try { await deleteMess(m.id); showToast('Mess deleted', 'success'); } catch (e) { showToast(e.message, 'error'); }
        });
      }));
    }

    // Admin rendering: students table
    function renderStudentTable(students){
      const tbody = document.getElementById('students-tbody');
      tbody.innerHTML = '';
      const q = (document.getElementById('students-search').value||'').toLowerCase();
      students.filter(s => !q || s.name?.toLowerCase().includes(q) || s.email?.toLowerCase().includes(q)).forEach(s => {
        const date = s.registeredAt?.toDate ? s.registeredAt.toDate() : (s.registeredAt ? new Date(s.registeredAt) : null);
        const d = date ? date.toLocaleDateString() : '‚Äî';
        const badge = s.status === 'active' ? `<span class="badge" style="background:#ECFDF5;color:#065F46;border:1px solid #A7F3D0;">Active</span>` : `<span class="badge" style="background:#FEF2F2;color:#991B1B;border:1px solid #FECACA;">Inactive</span>`;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(s.name||'')}</td>
          <td>${escapeHtml(s.email||'')}</td>
          <td>${escapeHtml(s.phone||'')}</td>
          <td>${d}</td>
          <td>${badge}</td>
          <td>
            <div class="table-actions">
              <button class="btn ghost small" data-edit="${s.id}">‚úèÔ∏è Edit</button>
              <button class="btn error small" data-delete="${s.id}">üóëÔ∏è Delete</button>
            </div>
          </td>`;
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', () => openStudentModal('edit', state.students.find(x => x.id === btn.dataset.edit))));
      tbody.querySelectorAll('[data-delete]').forEach(btn => btn.addEventListener('click', () => {
        const s = state.students.find(x => x.id === btn.dataset.delete);
        confirmDialog(`Delete student "${s.name}"?`, async () => {
          try { await deleteStudent(s.id); showToast('Student deleted', 'success'); } catch (e) { showToast(e.message, 'error'); }
        });
      }));
    }

    // Badges
    function badgeHtml(type){
      const cls = type === 'veg' ? 'veg' : type === 'non-veg' ? 'non-veg' : 'both';
      return `<span class="badge ${cls}">${type.replace('-', ' ').toUpperCase()}</span>`;
    }

    // Modals: Mess
    function openMessModal(mode, data){
      const isEdit = mode === 'edit';
      const m = data || { name:'', type:'veg', pricePerMeal:'', rating:'', todaysMenu:'', address:'', coordinates:{lat:'', lng:''}, phone:'' };
      const body = `
        <form id="mess-form">
          <div class="field"><label class="label">Mess Name*</label><input name="name" class="input" value="${escapeAttr(m.name)}" required /></div>
          <div class="field-inline">
            <div class="field"><label class="label">Type*</label>
              <select name="type" class="select" required>
                <option value="veg" ${m.type==='veg'?'selected':''}>Veg</option>
                <option value="non-veg" ${m.type==='non-veg'?'selected':''}>Non-Veg</option>
                <option value="both" ${m.type==='both'?'selected':''}>Both</option>
              </select>
            </div>
            <div class="field"><label class="label">Price per Meal* (‚Çπ)</label><input name="pricePerMeal" type="number" min="0" class="input" value="${escapeAttr(m.pricePerMeal)}" required /></div>
          </div>
          <div class="field-inline">
            <div class="field"><label class="label">Rating* (1-5)</label><input name="rating" type="number" min="1" max="5" step="0.1" class="input" value="${escapeAttr(m.rating)}" required /></div>
            <div class="field"><label class="label">Phone Number* (+91XXXXXXXXXX)</label><input name="phone" class="input" value="${escapeAttr(m.phone)}" required /></div>
          </div>
          <div class="field"><label class="label">Today's Menu* (comma-separated)</label><textarea name="todaysMenu" class="textarea" required>${(m.todaysMenu||[]).join(', ')}</textarea></div>
          <div class="field"><label class="label">Address*</label><textarea name="address" class="textarea" required>${escapeHtml(m.address||'')}</textarea></div>
          <div class="field-inline">
            <div class="field"><label class="label">Latitude*</label><input name="lat" type="number" step="any" class="input" value="${escapeAttr(m.coordinates?.lat)}" required /></div>
            <div class="field"><label class="label">Longitude*</label><input name="lng" type="number" step="any" class="input" value="${escapeAttr(m.coordinates?.lng)}" required /></div>
          </div>
        </form>`;
      openModal({
        title: isEdit ? 'Edit Mess' : 'Add New Mess',
        body,
        actions: [
          { label: 'Cancel', class: 'ghost', onClick: closeModal },
          { label: isEdit ? 'Save Changes' : 'Add Mess', class: 'success', onClick: async () => {
              const form = document.getElementById('mess-form');
              const fd = new FormData(form);
              const phone = fd.get('phone').trim();
              if (!/^\+?\d{10,15}$/.test(phone)) { showToast('Invalid phone number', 'error'); return; }
              const data = {
                name: fd.get('name').trim(),
                type: fd.get('type'),
                pricePerMeal: Number(fd.get('pricePerMeal')),
                rating: Number(fd.get('rating')),
                todaysMenu: String(fd.get('todaysMenu')).split(',').map(s => s.trim()).filter(Boolean),
                address: fd.get('address').trim(),
                coordinates: { lat: Number(fd.get('lat')), lng: Number(fd.get('lng')) },
                phone
              };
              try {
                if (isEdit) await updateMess(m.id, data); else await addMess(data);
                showToast(isEdit ? 'Mess updated' : 'Mess added', 'success');
                closeModal();
              } catch (e){ showToast(e.message, 'error'); }
            }
          }
        ]
      });
    }

    // Modals: Student
    function openStudentModal(mode, data){
      const isEdit = mode === 'edit';
      const s = data || { name:'', email:'', phone:'', address:'', status:'active' };
      const body = `
        <form id="student-form">
          <div class="field-inline">
            <div class="field"><label class="label">Full Name*</label><input name="name" class="input" value="${escapeAttr(s.name)}" required /></div>
            <div class="field"><label class="label">Email*</label><input name="email" type="email" class="input" value="${escapeAttr(s.email)}" required /></div>
          </div>
          <div class="field-inline">
            <div class="field"><label class="label">Phone Number*</label><input name="phone" class="input" value="${escapeAttr(s.phone)}" required /></div>
            <div class="field"><label class="label">Status*</label>
              <select name="status" class="select">
                <option value="active" ${s.status==='active'?'selected':''}>Active</option>
                <option value="inactive" ${s.status==='inactive'?'selected':''}>Inactive</option>
              </select>
            </div>
          </div>
          <div class="field"><label class="label">Address</label><textarea name="address" class="textarea">${escapeHtml(s.address||'')}</textarea></div>
        </form>`;
      openModal({
        title: isEdit ? 'Edit Student' : 'Add New Student',
        body,
        actions: [
          { label: 'Cancel', class: 'ghost', onClick: closeModal },
          { label: isEdit ? 'Save Changes' : 'Add Student', class: 'success', onClick: async () => {
              const form = document.getElementById('student-form');
              const fd = new FormData(form);
              const phone = fd.get('phone').trim();
              if (!/^\+?\d{10,15}$/.test(phone)) { showToast('Invalid phone number', 'error'); return; }
              const payload = {
                name: fd.get('name').trim(),
                email: fd.get('email').trim(),
                phone,
                address: fd.get('address').trim(),
                status: fd.get('status')
              };
              try {
                if (isEdit) await updateStudent(s.id, payload); else await addStudent(payload);
                showToast(isEdit ? 'Student updated' : 'Student added', 'success');
                closeModal();
              } catch (e){ showToast(e.message, 'error'); }
            }
          }
        ]
      });
    }

    // Dashboard stats
    function calculateStatistics(){
      const totalMesses = state.messes.length;
      const totalStudents = state.students.length;
      const avgRating = totalMesses ? (state.messes.reduce((a,b) => a + Number(b.rating||0), 0)/totalMesses) : 0;
      const popular = state.messes.slice().sort((a,b) => Number(b.rating)-Number(a.rating))[0];
      return { totalMesses, totalStudents, avgRating: avgRating.toFixed(2), popular: popular ? popular.name : '‚Äî' };
    }
    function renderDashboard(){
      const s = calculateStatistics();
      document.getElementById('stat-messes').textContent = s.totalMesses;
      document.getElementById('stat-students').textContent = s.totalStudents;
      document.getElementById('stat-rating').textContent = `${s.avgRating} ‚≠ê`;
      document.getElementById('stat-popular').textContent = s.popular;
    }

    // Seed sample data
    const SAMPLE_MESSES = [
      { name:'Shivneri Veg Mess', type:'veg', pricePerMeal:100, rating:4.6, todaysMenu:['Dal Tadka','Paneer Butter Masala','Jeera Rice','Phulka'], address:'Kothrud, Pune', coordinates:{lat:18.5074,lng:73.8077}, phone:'+919999000001' },
      { name:'Spice Route Non-Veg', type:'non-veg', pricePerMeal:180, rating:4.3, todaysMenu:['Chicken Curry','Egg Masala','Jeera Rice','Paratha'], address:'Hadapsar, Pune', coordinates:{lat:18.5089,lng:73.9260}, phone:'+919999000002' },
      { name:'Balanced Bite', type:'both', pricePerMeal:140, rating:4.5, todaysMenu:['Rajma','Paneer Bhurji','Chicken Curry','Roti'], address:'Viman Nagar, Pune', coordinates:{lat:18.5679,lng:73.9143}, phone:'+919999000003' },
      { name:'Pune Tiffin Center', type:'veg', pricePerMeal:90, rating:4.0, todaysMenu:['Sambar','Idli','Upma','Dosa'], address:'Shivajinagar, Pune', coordinates:{lat:18.5308,lng:73.8470}, phone:'+919999000004' },
      { name:'Deccan Delight', type:'both', pricePerMeal:150, rating:4.7, todaysMenu:['Veg Thali','Fish Curry','Rice','Chapati'], address:'Deccan Gymkhana, Pune', coordinates:{lat:18.5167,lng:73.8415}, phone:'+919999000005' },
      { name:'FC Road Non-Veg House', type:'non-veg', pricePerMeal:170, rating:4.2, todaysMenu:['Mutton Curry','Egg Curry','Rice','Bhakri'], address:'FC Road, Pune', coordinates:{lat:18.5286,lng:73.8446}, phone:'+919999000006' },
      { name:'Magarpatta Meals', type:'both', pricePerMeal:130, rating:4.4, todaysMenu:['Dal Fry','Chicken Biryani','Salad','Roti'], address:'Magarpatta, Pune', coordinates:{lat:18.5193,lng:73.9312}, phone:'+919999000007' },
      { name:'Baner Bhukkad', type:'veg', pricePerMeal:110, rating:3.9, todaysMenu:['Chole','Paneer Tikka','Rice','Naan'], address:'Baner, Pune', coordinates:{lat:18.5590,lng:73.7868}, phone:'+919999000008' },
      { name:'Kalyani Curry Club', type:'both', pricePerMeal:160, rating:4.8, todaysMenu:['Paneer Kadai','Chicken Tikka','Dal Makhani','Roti'], address:'Kalyani Nagar, Pune', coordinates:{lat:18.5516,lng:73.9010}, phone:'+919999000009' },
      { name:'Wakad Zaika', type:'non-veg', pricePerMeal:150, rating:3.8, todaysMenu:['Chicken Thali','Egg Bhurji','Rice','Chapati'], address:'Wakad, Pune', coordinates:{lat:18.5980,lng:73.7707}, phone:'+919999000010' }
    ];

    const SAMPLE_STUDENTS = [
      ['Aarav Mehta','aarav.mehta@example.com','+919820000001','active'],
      ['Isha Kulkarni','isha.kulkarni@example.com','+919820000002','active'],
      ['Rohan Patil','rohan.patil@example.com','+919820000003','inactive'],
      ['Priya Sharma','priya.sharma@example.com','+919820000004','active'],
      ['Karan Gupta','karan.gupta@example.com','+919820000005','active'],
      ['Sneha Joshi','sneha.joshi@example.com','+919820000006','inactive'],
      ['Aditya Deshmukh','aditya.deshmukh@example.com','+919820000007','active'],
      ['Neha Singh','neha.singh@example.com','+919820000008','active'],
      ['Sahil Khan','sahil.khan@example.com','+919820000009','inactive'],
      ['Pooja Nair','pooja.nair@example.com','+919820000010','active'],
      ['Vikas Rao','vikas.rao@example.com','+919820000011','active'],
      ['Simran Kaur','simran.kaur@example.com','+919820000012','inactive'],
      ['Rahul Verma','rahul.verma@example.com','+919820000013','active'],
      ['Ananya Iyer','ananya.iyer@example.com','+919820000014','active'],
      ['Harsh Jain','harsh.jain@example.com','+919820000015','inactive']
    ].map(([name,email,phone,status],i)=>({ name,email,phone,address:'',status, registeredAt: Date.now() - (i+1)*8640000 }));

    async function seedSampleData(){
      confirmDialog('Seed 10 sample messes and 15 students into Firestore?', async () => {
        try {
          // Avoid duplicates: simple check by name/email
          const existingM = await db.collection('messes').get();
          const names = new Set(existingM.docs.map(d => (d.data().name||'').toLowerCase()));
          const batch = db.batch();
          SAMPLE_MESSES.forEach(m => {
            if (!names.has(m.name.toLowerCase())){
              const ref = db.collection('messes').doc();
              batch.set(ref, { ...m, createdAt: firebase.firestore.FieldValue.serverTimestamp(), updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            }
          });
          const existingS = await db.collection('students').get();
          const emails = new Set(existingS.docs.map(d => (d.data().email||'').toLowerCase()));
          SAMPLE_STUDENTS.forEach(s => {
            if (!emails.has(s.email.toLowerCase())){
              const ref = db.collection('students').doc();
              batch.set(ref, { ...s, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
            }
          });
          await batch.commit();
          showToast('Sample data seeded', 'success');
        } catch (e){ showToast(e.message, 'error'); }
      });
    }

    // Geolocation
    function requestUserLocation(){
      if (!('geolocation' in navigator)) return;
      navigator.geolocation.getCurrentPosition((pos) => {
        state.userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        applyStudentQuery();
      }, (err) => {
        console.warn('Geolocation denied or failed', err);
        showToast('Location permission denied. Sorting by distance disabled.', 'error');
      }, { enableHighAccuracy: true, timeout: 8000 });
    }

    // Auth state observer
    function initAuth(){
      auth.onAuthStateChanged(async (user) => {
        state.user = user;
        if (!user){
          state.role = null;
          updateNavbar();
          showView('auth');
          // Unsubscribe listeners
          if (state.unsub.messes) { state.unsub.messes(); state.unsub.messes = null; }
          if (state.unsub.students) { state.unsub.students(); state.unsub.students = null; }
          return;
        }
        state.role = isAdmin(user.email) ? 'admin' : 'student';
        updateNavbar();
        if (state.role === 'admin'){
          showView('admin');
          showAdminPage('dashboard');
          // Realtime listeners
          state.unsub.messes = db.collection('messes').onSnapshot(snap => {
            state.messes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderMessTable(state.messes);
            renderDashboard();
          });
          state.unsub.students = db.collection('students').onSnapshot(snap => {
            state.students = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            renderStudentTable(state.students);
            renderDashboard();
          });
        } else {
          // Make sure there's a student profile if using Google sign-in
          try { await ensureStudentProfile(user); } catch (e) { console.warn(e); }

          showView('student');
          // One-time fetch messes for performance
          document.getElementById('student-loading').classList.remove('hidden');
          document.getElementById('mess-grid').classList.add('hidden');
          try {
            state.messes = await fetchMessesOnce();
          } catch (e){ showToast(e.message, 'error'); }
          document.getElementById('student-loading').classList.add('hidden');
          document.getElementById('mess-grid').classList.remove('hidden');
          requestUserLocation();
          applyStudentQuery();
        }
      });
    }

    // DOM & events
    document.addEventListener('DOMContentLoaded', () => {
      // Auth tab toggle
      const tabLogin = document.getElementById('tab-login');
      const tabRegister = document.getElementById('tab-register');
      const formLogin = document.getElementById('form-login');
      const formRegister = document.getElementById('form-register');
      tabLogin.addEventListener('click', () => { tabLogin.classList.replace('ghost','secondary'); tabRegister.classList.replace('secondary','ghost'); formLogin.classList.remove('hidden'); formRegister.classList.add('hidden'); });
      tabRegister.addEventListener('click', () => { tabRegister.classList.replace('ghost','secondary'); tabLogin.classList.replace('secondary','ghost'); formRegister.classList.remove('hidden'); formLogin.classList.add('hidden'); });

      // Auth forms
      formLogin.addEventListener('submit', (e) => {
        e.preventDefault();
        document.getElementById('login-error').classList.add('hidden');
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        const btn = document.getElementById('btn-login');
        const orig = btn.innerHTML; btn.innerHTML = '<span class="spinner"></span>'; btn.disabled = true;
        login(email, password).finally(() => { btn.innerHTML = orig; btn.disabled = false; });
      });

      formRegister.addEventListener('submit', (e) => {
        e.preventDefault();
        document.getElementById('register-error').classList.add('hidden');
        const name = document.getElementById('reg-name').value.trim();
        const phone = document.getElementById('reg-phone').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const pw = document.getElementById('reg-password').value;
        const pw2 = document.getElementById('reg-password2').value;
        const address = document.getElementById('reg-address').value.trim();
        if (pw !== pw2) { showToast('Passwords do not match', 'error'); return; }
        if (!/^\+?\d{10,15}$/.test(phone)) { showToast('Invalid phone number', 'error'); return; }
        const btn = document.getElementById('btn-register');
        const orig = btn.innerHTML; btn.innerHTML = '<span class="spinner"></span>'; btn.disabled = true;
        register(email, pw, { name, phone, address }).finally(() => { btn.innerHTML = orig; btn.disabled = false; });
      });

      // Google buttons
      const gl = document.getElementById('btn-google-login');
      if (gl) gl.addEventListener('click', () => loginWithGoogle());
      const gr = document.getElementById('btn-google-register');
      if (gr) gr.addEventListener('click', () => loginWithGoogle());

      // Navbar logout
      document.getElementById('btn-logout').addEventListener('click', logout);
      document.getElementById('admin-logout').addEventListener('click', logout);

      // Student filters
      document.querySelectorAll('.filters [data-filter]').forEach(btn => btn.addEventListener('click', (e) => {
        document.querySelectorAll('.filters [data-filter]').forEach(b => b.classList.remove('active'));
        e.currentTarget.classList.add('active');
        applyStudentQuery();
      }));
      document.querySelector('.filters [data-filter="all"]').classList.add('active');
      document.getElementById('search-input').addEventListener('input', applyStudentQuery);
      document.getElementById('sort-select').addEventListener('change', applyStudentQuery);

      // Admin nav
      document.querySelectorAll('.side-link[data-admin-page]').forEach(el => el.addEventListener('click', () => showAdminPage(el.dataset.adminPage)));

      // Admin Messes
      document.getElementById('btn-add-mess').addEventListener('click', () => openMessModal('add'));
      document.getElementById('messes-search').addEventListener('input', () => renderMessTable(state.messes));

      // Admin Students
      document.getElementById('btn-add-student').addEventListener('click', () => openStudentModal('add'));
      document.getElementById('students-search').addEventListener('input', () => renderStudentTable(state.students));
      document.getElementById('btn-export-students').addEventListener('click', exportStudentsCsv);

      // Dashboard seed
      document.getElementById('btn-seed').addEventListener('click', seedSampleData);

      // Start auth
      if (auth) initAuth();
    });

    // Export students CSV
    function exportStudentsCsv(){
      const rows = [['Name','Email','Phone','Status','RegisteredAt']].concat(state.students.map(s => [s.name||'', s.email||'', s.phone||'', s.status||'', (s.registeredAt?.toDate ? s.registeredAt.toDate() : new Date(s.registeredAt||Date.now())).toISOString()]));
      const csv = rows.map(r => r.map(x => '"' + String(x).replace(/"/g,'""') + '"').join(',')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'students.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // Helpers
    function escapeHtml(s){ return String(s||'').replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function escapeAttr(s){ return String(s??'').replace(/"/g,'&quot;'); }
  </script>
</body>
</html>
