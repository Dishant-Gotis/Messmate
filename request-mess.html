<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Request a New Mess</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Ensure form is readable on dark theme */
    .form-card { max-width: 680px; margin: 18px auto; padding: 16px; }
    .form-card label { display:block; margin:10px 0 6px; color: var(--text); font-weight:600; }
    .form-card input, .form-card select, .form-card textarea {
      width:100%; padding:12px 14px; border-radius:12px;
      background: var(--panel); color: var(--text);
      border: 1px solid rgba(255,255,255,0.18);
      outline: none; box-shadow: 0 0 0 0 var(--ring);
      transition: box-shadow .15s ease;
    }
    .form-card input::placeholder, .form-card textarea::placeholder { color: var(--muted); }
    .form-card input:focus, .form-card select:focus, .form-card textarea:focus { box-shadow: 0 0 0 6px var(--ring); }
    .msg { margin-top:8px; color: var(--muted); }
    .msg.error { color: #ff6a6a; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
    @media (max-width:640px){ .row{ grid-template-columns:1fr; } }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header class="app-header">
    <h1>Request a New Mess</h1>
    <p class="tagline">Submit your mess details for approval</p>
  </header>


  <main>
    <section class="card form-card">
      <div id="warn" class="msg"></div>


      <!-- Login box -->
      <div id="loginBox">
        <h3>Login</h3>
        <p>Enter your email to get a magic link:</p>
        <input type="email" id="loginEmail" placeholder="your@email.com"/>
        <button id="loginBtn" class="btn" type="button">Send Magic Link</button>
        <p id="loginMsg" class="msg"></p>
      </div>


      <!-- Request form (hidden until login) -->
      <form id="requestForm" style="display:none; margin-top:16px">
        <label>Name of Mess</label>
        <input type="text" id="messName" required/>


        <label>Area</label>
        <input type="text" id="messArea"/>


        <label>Type</label>
        <select id="messType">
          <option value="veg">Veg</option>
          <option value="nonveg">Non-Veg</option>
          <option value="both">Both</option>
        </select>


        <label>Hours</label>
        <input type="text" id="messHours" placeholder="7â€“10, 12â€“15, 19â€“22"/>


        <label>Phone</label>
        <input type="text" id="messPhone"/>


        <label>Address</label>
        <input type="text" id="messAddress"/>


        <div class="row">
          <div>
            <label>Latitude</label>
            <input type="number" step="any" id="messLat"/>
          </div>
          <div>
            <label>Longitude</label>
            <input type="number" step="any" id="messLng"/>
          </div>
        </div>


        <label>Notes</label>
        <textarea id="messNotes" rows="3" placeholder="Anything the admin should know"></textarea>


        <button type="submit" class="btn">Submit Request</button>
        <p id="reqMsg" class="msg"></p>
      </form>
    </section>
  </main>


  <footer class="footer">
    Â© 2025 MessMate â€”
    <a href="index.html">Home</a> Â· <a href="owner.html">Owner: Submit Menu</a> Â· <a href="admin.html">Admin</a>
  </footer>


  <script>
    // ðŸ”‘ Replace these with your real project values (Settings â†’ API)
    const SUPABASE_URL = "https://nffcmficrtylnmildrzc.supabase.co"; // <-- replace
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mZmNtZmljcnR5bG5taWxkcnpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDM5MTQsImV4cCI6MjA3NDk3OTkxNH0.EGYiE5zvKDUNtbD86GtxlN7EcQjNt84RFdfydN5-oyM";             // <-- replace


    const warn = document.getElementById('warn');
    if (SUPABASE_URL.includes("YOUR_PROJECT_REF") || SUPABASE_KEY.includes("YOUR_ANON_PUBLIC_KEY")) {
      warn.innerHTML = "<span class='msg error'>Set SUPABASE_URL and SUPABASE_KEY at top of page.</span>";
    }
    if (location.protocol === "file:") {
      warn.innerHTML = "<span class='msg error'>Open with VS Code Live Server (http://127.0.0.1:5500), not file://</span>";
    }


    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);


    const loginBox = document.getElementById("loginBox");
    const loginEmail = document.getElementById("loginEmail");
    const loginBtn = document.getElementById("loginBtn");
    const loginMsg = document.getElementById("loginMsg");


    const requestForm = document.getElementById("requestForm");
    const reqMsg = document.getElementById("reqMsg");


    loginBtn.addEventListener('click', async () => {
      loginMsg.textContent = "Sending...";
      const { error } = await sb.auth.signInWithOtp({ email: loginEmail.value.trim() });
      loginMsg.textContent = error ? ("Error: " + error.message) : "Magic link sent! Check your email.";
    });


    async function updateUI(){
      const { data:{ session } } = await sb.auth.getSession();
      if (session && session.user) {
        loginBox.style.display = "none";
        requestForm.style.display = "block";
      } else {
        loginBox.style.display = "block";
        requestForm.style.display = "none";
      }
    }
    sb.auth.onAuthStateChange(updateUI);
    updateUI();


    requestForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      reqMsg.textContent = "Submitting...";
      const { data:{ user } } = await sb.auth.getUser();
      if (!user) { reqMsg.textContent = "Not logged in."; return; }
      const payload = {
        requested_by: user.id,
        name: document.getElementById("messName").value.trim(),
        area: document.getElementById("messArea").value.trim(),
        type: document.getElementById("messType").value,
        hours: document.getElementById("messHours").value.trim(),
        phone: document.getElementById("messPhone").value.trim(),
        address: document.getElementById("messAddress").value.trim(),
        lat: parseFloat(document.getElementById("messLat").value) || null,
        lng: parseFloat(document.getElementById("messLng").value) || null,
        notes: document.getElementById("messNotes").value.trim()
      };
      const { error } = await sb.from("mess_request").insert(payload);
      reqMsg.textContent = error ? ("Error: " + error.message) : "Submitted. Admin will review.";
      if (!error) requestForm.reset();
    });
  </script>
</body>
</html>



