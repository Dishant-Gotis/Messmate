<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin — Approvals</title>
  <link rel="stylesheet" href="style.css" />
  <!-- Load supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<header class="app-header">
  <h1>Approvals</h1>
  <p class="tagline">Approve mess requests and daily menus</p>
</header>


<main class="layout" style="max-width:1100px;margin:0 auto">
  <section class="card" style="padding:14px">
    <div id="auth" class="muted"></div>
  </section>


  <section>
    <h2>Pending Menus</h2>
    <div id="menus" class="muted">—</div>
  </section>


  <section style="margin-top:18px">
    <h2>Mess Requests</h2>
    <div id="reqs" class="muted">—</div>
  </section>
</main>


<footer class="footer">
  © 2025 MessMate —
  <a href="index.html">Home</a> ·
  <a href="request-mess.html">Add Your Mess</a> ·
  <a href="owner.html">Owner: Submit Menu</a>
</footer>


<script>
/*** 1) PUT YOUR SUPABASE VALUES HERE  ***/
const SUPABASE_URL = "https://nffcmficrtylnmildrzc.supabase.co"; // <-- replace
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5mZmNtZmljcnR5bG5taWxkcnpjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk0MDM5MTQsImV4cCI6MjA3NDk3OTkxNH0.EGYiE5zvKDUNtbD86GtxlN7EcQjNt84RFdfydN5-oyM";             // <-- replace


// Safety: show immediate warning if not replaced
if (URL.includes("YOUR_PROJECT_REF") || KEY.includes("YOUR_ANON_PUBLIC_KEY")) {
  document.getElementById('auth').innerHTML =
    '<b style="color:#ff6a6a">Set SUPABASE URL and ANON KEY at top of admin.html</b>';
}


// Create client
const db = supabase.createClient(URL, KEY);


const authDiv = document.getElementById('auth');
const menusDiv = document.getElementById('menus');
const reqsDiv = document.getElementById('reqs');


function uiLogin() {
  authDiv.innerHTML = `
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <button id="login" class="btn">Admin Login (magic link)</button>
      <span class="muted">Use the same admin email you set in <code>is_admin()</code>.</span>
    </div>
  `;
  document.getElementById('login').onclick = async () => {
    const email = prompt("Admin email:");
    if (!email) return;
    const { error } = await db.auth.signInWithOtp({ email });
    if (error) alert(error.message);
    else alert("Magic link sent. Open the email and click the link, then come back here.");
  };
}


function uiAuthed(email) {
  authDiv.innerHTML = `
    Logged in as <b>${email}</b>
    <button id="logout" class="btn-outline tiny" style="margin-left:8px">Logout</button>
  `;
  document.getElementById('logout').onclick = async () => {
    await db.auth.signOut();
    location.reload();
  };
}


async function ensureSession() {
  try {
    const { data:{ session } } = await db.auth.getSession();
    if (!session) { uiLogin(); menusDiv.textContent = "—"; reqsDiv.textContent = "—"; return; }
    uiAuthed(session.user.email);
    // Load data
    await Promise.all([loadPendingMenus(), loadMessRequests()]);
  } catch (e) {
    authDiv.innerHTML = '<span style="color:#ff6a6a">Auth error: ' + e.message + '</span>';
  }
}


async function loadPendingMenus(){
  menusDiv.textContent = 'Loading...';
  const { data, error } = await db
    .from('menu_submission')
    .select('id, date, status, notes, items, mess:mess_id(name)')
    .eq('status','PENDING')
    .order('date',{ ascending:false });
  if (error) { menusDiv.innerHTML = `<span style="color:#ff6a6a">${error.message}</span>`; return; }
  if (!data || !data.length) { menusDiv.textContent = 'No pending menus.'; return; }
  menusDiv.innerHTML = data.map(r => `
    <div class="card" style="padding:12px;margin:8px 0;border:1px solid #ddd;border-radius:8px">
      <h3 style="margin:0 0 4px">${r.mess.name} — ${r.date}</h3>
      <p style="margin:0 0 8px">${(r.items||[]).join(', ')}</p>
      <textarea id="m_${r.id}" placeholder="Notes (optional)" style="width:100%;min-height:60px">${r.notes||''}</textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="approveMenu('${r.id}')" class="btn">Approve</button>
        <button onclick="rejectMenu('${r.id}')" class="btn-outline">Reject</button>
      </div>
    </div>
  `).join('');
}


async function approveMenu(id){
  const notes = document.getElementById('m_'+id).value;
  const { error } = await db.from('menu_submission').update({ status:'APPROVED', notes }).eq('id', id);
  if (error) alert(error.message); else loadPendingMenus();
}
async function rejectMenu(id){
  const notes = document.getElementById('m_'+id).value;
  const { error } = await db.from('menu_submission').update({ status:'REJECTED', notes }).eq('id', id);
  if (error) alert(error.message); else loadPendingMenus();
}


async function loadMessRequests(){
  reqsDiv.textContent = 'Loading...';
  const { data, error } = await db
    .from('mess_request')
    .select('id, name, area, type, hours, phone, address, lat, lng, created_at, notes, status')
    .eq('status','PENDING')
    .order('created_at',{ ascending:false });
  if (error) { reqsDiv.innerHTML = `<span style="color:#ff6a6a">${error.message}</span>`; return; }
  if (!data || !data.length) { reqsDiv.textContent = 'No pending mess requests.'; return; }
  reqsDiv.innerHTML = data.map(r => `
    <div class="card" style="padding:12px;margin:8px 0;border:1px solid #ddd;border-radius:8px">
      <h3 style="margin:0 0 4px">${r.name} — ${r.area||''}</h3>
      <p><b>Type:</b> ${r.type} | <b>Hours:</b> ${r.hours||'-'} | <b>Phone:</b> ${r.phone||'-'}</p>
      <p><b>Address:</b> ${r.address||'-'}</p>
      <p><b>Coords:</b> ${r.lat||'-'}, ${r.lng||'-'}</p>
      <textarea id="rq_${r.id}" placeholder="Notes (optional)" style="width:100%;min-height:60px">${r.notes||''}</textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button onclick="approveReq('${r.id}')" class="btn">Approve</button>
        <button onclick="rejectReq('${r.id}')" class="btn-outline">Reject</button>
      </div>
    </div>
  `).join('');
}
async function approveReq(id){
  const notes = document.getElementById('rq_'+id).value;
  const { error } = await db.from('mess_request').update({ status:'APPROVED', notes }).eq('id', id);
  if (error) alert(error.message); else loadMessRequests();
}
async function rejectReq(id){
  const notes = document.getElementById('rq_'+id).value;
  const { error } = await db.from('mess_request').update({ status:'REJECTED', notes }).eq('id', id);
  if (error) alert(error.message); else loadMessRequests();
}


ensureSession();
db.auth.onAuthStateChange(ensureSession);
</script>
</body>
</html>



